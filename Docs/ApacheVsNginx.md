#Apache VS NGINX
##简介
**Apache** 和 **Nginx**是现在最常用的两种开源网络服务器,二者加起来承担了网络上百分之50的流量。二者能够处理不同的工作负载并且能够和其他的软件一起，提供一个完整的网络环境  

虽然Apache和Nginx有很多共同点，但是我们不能认为他们可以完全痛哟哦那个。它们都有各自的长处，了解他们的长处与短处有助于重新评估的web服务器的选择。

##概览
在深入了解Apache和Nginx不同之前，简单的回顾下两个服务器软件的背景与特性。

**Apache** 服务器是1995年由 Robert McCool在Apache基金会的领导下开发出来的。因为Apache的灵活性，高性能和高扩展。它通常被系统管理员选择作为web服务器。它可以通过动态加载模块，来拓展功能，并且可以通过不连接其他第三方软件的情况下，执行多种解释型语言。  

**Nginx** 在2002年，Igor Sysoev开始着手写Nginx服务器来解决C10K问题。C10K问题是Web服务器的一个挑战，要求同一个web服务器在同一时刻可以处理10000个连接请求，Nginx在2004年通过依靠异步事件驱动架构来实现这个目的，并且发布了它的初始版本

Nginx的流行，源于它轻量级资源使用率和它能够扩展到小型设备上。Nginx擅长快速处理静态内容，并且它旨在将动态请求传递給更适合这些目的的其他软件。

##对比
**Nginx**  
 
1. **轻量级**，采用C进行编写，同样的Web服务器，会占用更少的内存与资源  
2. **抗并发**，Nginx以epoll and kqueue作为开发模型，处理请求**异步非阻塞**，负载能力比Apache高很多，而Apache则是阻塞型。在高并发下Nginx能够保持低资源低消耗高性能，而Apache在PHP处理慢或者前端压力很大的时候，很容易出现进程数飙升，从而拒绝服务的情况。  
3. Nginx处理静态文件的能力比Apache高出三倍以上。  
4. Nginx的设计高度模块化，编写模块相对简单。
5. Nginx配置简洁，正则配置让很多事情变的简单，而且改完配置能够使用 -t测试配置是否有问题，Apache配置复杂。  
6. Nginx作为负载均衡服务器，支持7层负载均衡  
7. Nginx本身是一个反响代理服务器，而且可以作为非常优秀的邮件代理服务器。
8. 容易启动，并且能够做到7*24不间断运行，即使运行数月也不需要重新启动，还能够不间断服务的情况下进行软件的版本升级  
9. 社区活跃，快速出品各种高性能模块  

___

**Apache**  

1. Apache的rewrite比Nginx强大，在rewrite频繁的情况下，用Apache  
2. Apache发展到现在，模块很多，能覆盖用户的基本需求  
3. Apache 很稳定  
4. Apache 对PHP的支持较为简单，Nginx需要配合其他后端使用  
5. Apache对处理动态请求有优势，Nginx在这方面逊色一些。一般动态请求要Apache去做，Nginx适合静态和反向。  
6. Apache仍然是主流，拥有丰富的特性，成熟的技术和开发社区。  

##一点解释
### Apache
Apache在高负载的情况下表现的差强人意，原因是它需要运行新的进程，所以更加的消耗内存，同时，他还要产生新的线程来与其他的线程竞争CPU和内存。当进程的流量达到了管理员设置的上限时，Apache会拒绝新的连接。  

Apache可以通过设置来运行pre－forked模式或者worker multi-process模式(MPM).当其他的用户连接时，两种方式都会创建新的进程。区别在于，pre-fork模式为每一个进程创建一个线程，用来处理一个用户的请求。worker模式也创建新的进程，但是每一个进程至少有一个线程，每一个线程用来处理单个用户的单个请求。所以一个worker mode的进程处理至少一个连接，而一个pre-fork模式的进程只处理一个连接。  

相比forker模式，worker模式使用更少的内存，原因是进程比线程消耗更多的内存，线程只是运行进程中的代码。  

在调整Apache时的一个限制因素是内存以及当争夺一个CPU和内存时潜在的线程死锁问题。如果一个线程停止了，用户会一直处于等待页面出现的状态，直至进程将该线程回收，以便可以发回页面。如果一个线程发生了死锁，它不知道如何重启，因此会一直处于卡住状态。

###Nginx

和Apache相比，Nginx的工作方式有很大不同，主要是在于它如何处理线程。  

Nginx并不会为每一个Web请求创建新的进程，相反，管理员可以配置Nginx主进程的工作进程数量(一个常见的做法是为每一个CPU配置一个工作进程)。所有这些进程都是单线程的。每一个工作进程可以处理数千个并发请求。它通过一个线程来异步的完成这些工作，而没有使用多线程的编程模型。  

Nginx还拆分了缓存加载器(Cache Loader)和缓存管理器(Cache Manager)进程用来从磁盘中读取数据，并将其加载到缓存中  

Nginx有一系列的模块组成，这些模块在编译的时候，就被包含进去了。这些模块中包含连接后端应用服务器，负载均衡，代理服务器以及其他。并没有PHP模块，因为Nginx可以自己编译PHP代码

**Nginx架构图**  
![avatar](https://timgsa.baidu.com/timg?image&quality=80&size=b9999_10000&sec=1504156505808&di=2380b9d584942205ee9b8b9204a42609&imgtype=0&src=http%3A%2F%2Fimage.lxway.com%2Fupload%2Fc%2Fe8%2Fce8fe7cd7e37933775a4d85c15286bbd.jpg)  

通过上图我们可以看出，Nginx使用FastCgi进程来执行Python，Ruby以及其他代码，使用Memcached对象缓存系统。工作进程为Http请求加载ht_core Nginx进程。我们还可以看到，Nginx和Windows以及Linux内核的功能紧密的集成在了一起，以便提升性能。  

Nginx声称是事件驱动，异步无阻塞的。事件指的是一个用户的连接。异步指的是它一次处理多个用户连接的用户交互。 无阻塞 指的是它不会犹豫CPU处于忙状态而停止磁盘I/O,在这种情况下，她会处理其他事件，知道I/O资源得到释放。

##总结

两者核心区别在于Apache是同步多进程模型，一个连接对应一个进程，而Nginx是异步的，多个连接可以对应一个进程  

一般来说，要求性能的Web服务器，使用Nginx。如果不要求性能，更求稳定，可以使用Apache，后者的功能模块是多于Nginx的。   

epoll(freebsd 上时kqueue) 网络IO模型是Nginx处理性能高的根本理由，但是当如果本身提供的静态服务就只有几个文件，Apache的select 模型或许比epoll更高性能。  

通用的方案为，前端Nginx抗并发，后端Apache集群，配合起来会更好
